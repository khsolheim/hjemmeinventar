generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String            @id @default(cuid())
  email         String            @unique
  name          String?
  image         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  password      String?
  accounts      Account[]
  activities    Activity[]
  households    HouseholdMember[]
  items         Item[]
  itemRelations ItemRelation[]
  labelSizes    LabelSize[]
  loans         Loan[]
  locations     Location[]
  sessions      Session[]
  tags          Tag[]
  yarnPatterns  YarnPattern[]
  yarnProjects  YarnProject[]
}

model Location {
  id            String             @id @default(cuid())
  name          String
  description   String?
  type          LocationType
  qrCode        String             @unique
  parentId      String?
  userId        String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  activities    Activity[]
  items         Item[]
  distributions ItemDistribution[]
  parent        Location?          @relation("LocationHierarchy", fields: [parentId], references: [id])
  children      Location[]         @relation("LocationHierarchy")
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([parentId])
  @@index([qrCode])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?
  fieldSchema Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       Item[]
}

model Item {
  id                String             @id @default(cuid())
  name              String
  totalQuantity     Int                @default(1)
  availableQuantity Decimal            @default(0)
  consumedQuantity  Decimal            @default(0)
  unit              String             @default("stk")
  description       String?
  imageUrl          String?
  purchaseDate      DateTime?
  expiryDate        DateTime?
  price             Decimal?           @db.Decimal(10, 2)
  barcode           String?
  brand             String?
  categoryData      Json?
  userId            String
  categoryId        String?
  locationId        String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  activities        Activity[]
  attachments       Attachment[]
  category          Category?          @relation(fields: [categoryId], references: [id])
  location          Location           @relation(fields: [locationId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  distributions     ItemDistribution[]
  itemRelationsFrom ItemRelation[]     @relation("ItemRelationsFrom")
  itemRelationsTo   ItemRelation[]     @relation("ItemRelationsTo")
  loan              Loan?
  projectUsage      ProjectYarnUsage[]
  Item_A            Item[]             @relation("ItemRelations")
  Item_B            Item[]             @relation("ItemRelations")
  tags              Tag[]              @relation("ItemTags")

  @@index([userId])
  @@index([categoryId])
  @@index([locationId])
  @@index([expiryDate])
  @@index([barcode])
  @@index([availableQuantity])
}

model ItemDistribution {
  id          String              @id @default(cuid())
  quantity    Decimal
  notes       String?
  purpose     DistributionPurpose @default(STORAGE)
  reservedFor String?
  displayInfo Json?
  itemId      String
  locationId  String
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  item        Item                @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location    Location            @relation(fields: [locationId], references: [id])

  @@index([itemId])
  @@index([locationId])
}

model ItemRelation {
  id           String       @id @default(cuid())
  relationType RelationType
  fromItemId   String
  toItemId     String
  userId       String
  createdAt    DateTime     @default(now())
  fromItem     Item         @relation("ItemRelationsFrom", fields: [fromItemId], references: [id], onDelete: Cascade)
  toItem       Item         @relation("ItemRelationsTo", fields: [toItemId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([fromItemId, toItemId, relationType])
  @@index([fromItemId])
  @@index([toItemId])
  @@index([userId])
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType
  description String
  metadata    Json?
  userId      String
  itemId      String?
  locationId  String?
  createdAt   DateTime     @default(now())
  item        Item?        @relation(fields: [itemId], references: [id])
  location    Location?    @relation(fields: [locationId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Household {
  id          String            @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  members     HouseholdMember[]
}

model HouseholdMember {
  id          String        @id @default(cuid())
  role        HouseholdRole @default(MEMBER)
  userId      String
  householdId String
  joinedAt    DateTime      @default(now())
  household   Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, householdId])
}

model YarnPattern {
  id             String             @id @default(cuid())
  name           String
  description    String?
  patternFileUrl String?
  imageUrls      String[]
  difficulty     PatternDifficulty?
  estimatedTime  String?
  needleSize     String?
  gauge          String?
  yarnWeight     String?
  yarnAmount     String?
  userId         String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects       YarnProject[]

  @@index([userId])
}

model YarnProject {
  id             String             @id @default(cuid())
  name           String
  description    String?
  status         ProjectStatus      @default(PLANNED)
  progressImages String[]
  finalImages    String[]
  notes          String?
  startDate      DateTime?
  completedDate  DateTime?
  patternId      String?
  userId         String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  yarnUsage      ProjectYarnUsage[]
  pattern        YarnPattern?       @relation(fields: [patternId], references: [id])
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model ProjectYarnUsage {
  id           String      @id @default(cuid())
  quantityUsed Decimal
  notes        String?
  projectId    String
  itemId       String
  createdAt    DateTime    @default(now())
  item         Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  project      YarnProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, itemId])
}

model Loan {
  id                 String     @id @default(cuid())
  loanedTo           String
  contactInfo        String?
  loanDate           DateTime   @default(now())
  expectedReturnDate DateTime?
  actualReturnDate   DateTime?
  notes              String?
  status             LoanStatus @default(OUT)
  itemId             String     @unique
  userId             String
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  item               Item       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user               User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([expectedReturnDate])
}

model Tag {
  id        String   @id @default(cuid())
  name      String
  color     String   @default("#6B7280")
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     Item[]   @relation("ItemTags")

  @@unique([name, userId])
  @@index([userId])
}

model Attachment {
  id        String         @id @default(cuid())
  url       String
  filename  String
  filetype  String
  filesize  Int
  type      AttachmentType @default(OTHER)
  itemId    String
  createdAt DateTime       @default(now())
  item      Item           @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([type])
}

model LabelSize {
  id          String   @id @default(cuid())
  name        String
  width       Int
  height      Int
  widthMm     Int
  heightMm    Int
  description String?
  isDefault   Boolean  @default(false)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
  @@index([userId])
}

enum LocationType {
  ROOM
  CABINET
  SHELF
  BOX
  BAG
  DRAWER
  RACK
  WALL_SHELF
  CONTAINER
  SHELF_COMPARTMENT
  SECTION
}

enum DistributionPurpose {
  STORAGE
  DISPLAY
  RESERVED
  WORK
}

enum ActivityType {
  ITEM_CREATED
  ITEM_UPDATED
  ITEM_MOVED
  ITEM_DELETED
  LOCATION_CREATED
  HOUSEHOLD_CREATED
  QR_SCANNED
  BULK_OPERATION
  LOAN_CREATED
  LOAN_RETURNED
}

enum HouseholdRole {
  ADMIN
  MEMBER
  READONLY
}

enum RelationType {
  MASTER_OF
  BATCH_OF
  REMNANT_OF
  RELATED_TO
  COLOR_OF
}

enum ProjectStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}

enum PatternDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum AttachmentType {
  RECEIPT
  WARRANTY
  MANUAL
  PHOTO
  CERTIFICATE
  INVOICE
  OTHER
}

enum LoanStatus {
  OUT
  RETURNED
  OVERDUE
}
